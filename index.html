<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSC Answer Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8;
            scroll-behavior: smooth;
        }
        .modern-card { 
            background-color: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(226, 232, 240, 0.7);
            transition: all 0.3s ease;
        }
        .loader { 
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            display: inline-block; 
            position: relative; 
            border: 3px solid; 
            border-color: #3b82f6 #3b82f6 transparent transparent; 
            box-sizing: border-box; 
            animation: rotation 1s linear infinite; 
        }
        @keyframes rotation { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="bg-white/80 shadow-sm sticky top-0 z-20 backdrop-blur-md border-b border-slate-200 mb-8 rounded-xl">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>UPSC Answer Evaluator</span>
                </h1>
                <button onclick="clearAll()" class="text-sm font-medium text-slate-600 hover:text-blue-600 transition-colors">Clear All</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-6">
                
                <div class="modern-card p-6 rounded-xl shadow-lg fade-in">
                    <h2 class="text-xl font-semibold mb-4 text-slate-700">1. The Question</h2>
                    <div class="relative">
                        <textarea id="question-textarea" class="w-full p-3 border border-slate-300 rounded-lg min-h-[120px] bg-slate-50/50 focus:ring-2 focus:ring-blue-500 transition" placeholder="Paste the UPSC question here..."></textarea>
                    </div>
                </div>

                <div class="modern-card p-6 rounded-xl shadow-lg fade-in" style="animation-delay: 100ms;">
                    <h2 class="text-xl font-semibold mb-4 text-slate-700">2. Your Answer</h2>
                    <div class="relative">
                        <textarea id="answer-textarea" class="w-full p-3 border border-slate-300 rounded-lg min-h-[180px] bg-slate-50/50 focus:ring-2 focus:ring-blue-500 transition" placeholder="Paste your answer text here, or upload images of your handwritten answer below..."></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="cursor-pointer text-sm text-blue-600 hover:text-blue-700 font-semibold transition-colors">
                            + Upload Images (Handwritten Answer)
                            <input id="answer-file-input" type="file" accept="image/*" multiple class="hidden" />
                        </label>
                    </div>
                    <div id="answer-files-container" class="mt-4 space-y-2"></div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 fade-in" style="animation-delay: 200ms;">
                    <button id="evaluate-btn" onclick="evaluateAnswer()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Evaluate Answer
                    </button>
                     <button id="generate-btn" onclick="generateFullModelAnswer()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-700 text-white font-semibold rounded-lg shadow-lg hover:bg-slate-800 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M4 17v4M2 19h4M17 3v4M15 5h4M17 17v4M15 19h4"></path></svg>
                        Generate Model Answer
                    </button>
                </div>
            </div>

            <div class="sticky top-28 h-full">
                <div id="output-section" class="modern-card p-6 rounded-xl shadow-lg min-h-[500px] max-h-[80vh] overflow-y-auto">
                    <h2 class="text-xl font-semibold mb-4 text-slate-700">Evaluation Panel</h2>
                    <div id="output-container"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 w-full max-w-xs space-y-3"></div>
<script>
    // --- STATE MANAGEMENT & DOM REFERENCES ---
    let state = {
        questionText: '',
        answerText: '',
        answerFiles: [],
        loadingState: {},
        evaluationResult: null,
        generatedModelAnswer: null,
        message: ''
    };
    let questionTextarea, answerTextarea, answerFileInput, answerFilesContainer, evaluateBtn, generateBtn, outputContainer, outputSection;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Assign DOM elements
        questionTextarea = document.getElementById('question-textarea');
        answerTextarea = document.getElementById('answer-textarea');
        answerFileInput = document.getElementById('answer-file-input');
        answerFilesContainer = document.getElementById('answer-files-container');
        evaluateBtn = document.getElementById('evaluate-btn');
        generateBtn = document.getElementById('generate-btn');
        outputContainer = document.getElementById('output-container');
        outputSection = document.getElementById('output-section');
        
        // Attach event listeners
        questionTextarea.addEventListener('input', e => { state.questionText = e.target.value; updateButtons(); });
        answerTextarea.addEventListener('input', e => { state.answerText = e.target.value; updateButtons(); });
        answerFileInput.addEventListener('change', handleAnswerImageUpload);
        
        updateUI(); // Initial render
    });

    // --- UI & STATE UPDATERS ---
    function updateMessage(message, isError = false) {
        state.message = message;
        if (Object.values(state.loadingState).some(Boolean)) renderOutput();
        if (!message) return;

        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `p-4 rounded-xl shadow-lg text-sm font-medium ${isError ? 'bg-red-500 text-white' : 'bg-white text-slate-800'}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function setLoading(key, value) {
        state.loadingState[key] = value;
        updateUI();
    }

    function updateUI() {
        if (!questionTextarea) return;
        renderAnswerFiles();
        renderOutput();
        updateButtons();
    }

    function updateButtons() {
        const isAnyLoading = Object.values(state.loadingState).some(Boolean);
        const canEvaluate = state.questionText.trim() && (state.answerText.trim() || state.answerFiles.length > 0);
        evaluateBtn.disabled = isAnyLoading || !canEvaluate;
        generateBtn.disabled = isAnyLoading || !state.questionText.trim();
    }

    // --- RENDERING FUNCTIONS ---
    function renderAnswerFiles() {
        if (!answerFilesContainer) return;
        answerFilesContainer.innerHTML = '';
        state.answerFiles.forEach(item => {
            const fileDiv = document.createElement('div');
            fileDiv.className = "flex items-center justify-between bg-slate-100 p-2 rounded-md text-sm fade-in";
            fileDiv.innerHTML = `<span class="truncate pr-2">${item.file.name}</span><button onclick="removeAnswerFile('${item.id}')" class="text-red-500 font-bold px-2 rounded-full hover:bg-red-100 transition-colors">&times;</button>`;
            answerFilesContainer.appendChild(fileDiv);
        });
    }

    function renderOutput() {
        if (!outputContainer) return;
        const isLoading = Object.values(state.loadingState).some(Boolean);

        if (isLoading) {
            outputContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-96"><span class="loader"></span><p class="mt-4 font-medium text-slate-600">${state.message}</p></div>`;
            return;
        }

        if (state.evaluationResult) {
            const { score, maxMarks, detailed_feedback: feedback, overall_assessment: assessment } = state.evaluationResult;
            const renderList = items => !items || items.length === 0 ? '<p class="text-slate-500 italic text-sm">N/A</p>' : `<ul class="list-disc pl-5 space-y-1 text-slate-700">${items.map(item => `<li>${item}</li>`).join('')}</ul>`;
            
            outputContainer.innerHTML = `
                <div class="space-y-6 prose prose-sm max-w-none">
                    <div class="text-center bg-slate-100 p-4 rounded-lg not-prose">
                        <h3 class="text-sm font-medium text-slate-600">SCORE</h3>
                        <p class="text-5xl font-bold text-blue-600 tracking-tight">${score}<span class="text-3xl text-slate-400 font-medium">/${maxMarks}</span></p>
                    </div>

                    <div>
                        <h3 class="font-semibold text-slate-800 border-b pb-2 mb-3">Overall Assessment</h3>
                        <div class="space-y-4">
                            <div><h4 class="font-semibold">Presentation & Style:</h4>${renderMarkdown(assessment.presentation_and_style)}</div>
                            <div><h4 class="font-semibold">Holistic Strengths:</h4>${renderList(assessment.holistic_strengths)}</div>
                            <div><h4 class="font-semibold">Priority Areas for Improvement:</h4>${renderList(assessment.priority_areas_for_improvement)}</div>
                        </div>
                    </div>
                    <hr/>
                    <div>
                        <h3 class="font-semibold text-slate-800 border-b pb-2 mb-3">Detailed Feedback</h3>
                        <div class="space-y-4">
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <h4 class="font-semibold">Introduction</h4>
                                <div class="mt-2 space-y-2">
                                    <div><strong>Strengths:</strong>${renderMarkdown(feedback.introduction.strengths)}</div>
                                    <div><strong>Weaknesses:</strong>${renderMarkdown(feedback.introduction.weaknesses)}</div>
                                    <div><strong>Suggestions:</strong>${renderList(feedback.introduction.suggestions_for_improvement)}</div>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <h4 class="font-semibold">Body Paragraphs</h4>
                                ${feedback.body_evaluation.map(s => `
                                    <div class="mt-3 pt-3 border-t">
                                        <h5 class="font-semibold">${s.section_title}</h5>
                                        <div class="mt-2 space-y-2">
                                            <div><strong>Strengths:</strong>${renderMarkdown(s.evaluation.strengths)}</div>
                                            <div><strong>Weaknesses:</strong>${renderMarkdown(s.evaluation.weaknesses)}</div>
                                        </div>
                                    </div>`).join('') || '<p>No body paragraphs were evaluated.</p>'}
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <h4 class="font-semibold">Conclusion</h4>
                                <div class="mt-2 space-y-2">
                                    <div><strong>Strengths:</strong>${renderMarkdown(feedback.conclusion.strengths)}</div>
                                    <div><strong>Weaknesses:</strong>${renderMarkdown(feedback.conclusion.weaknesses)}</div>
                                    <div><strong>Suggestions:</strong>${renderList(feedback.conclusion.suggestions_for_improvement)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        } else if (state.generatedModelAnswer) {
             outputContainer.innerHTML = `<div class="prose prose-sm max-w-none"><h3>Model Answer</h3>${renderMarkdown(state.generatedModelAnswer)}</div>`;
        } else {
            outputContainer.innerHTML = `<div class="text-center text-slate-500 pt-16 h-96 flex flex-col items-center justify-center"><svg class="w-16 h-16 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p class="mt-4">Your evaluation report will appear here.</p></div>`;
        }
    }

    function renderMarkdown(text) {
        if (!text || text.trim().toLowerCase() === 'n/a' || text.trim() === '') return '<p class="text-slate-500 italic text-sm">N/A</p>';
        
        let html = text
            .replace(/</g, "&lt;").replace(/>/g, "&gt;")
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        let lines = html.split('\n');
        let processedLines = [], listStack = [];
        
        lines.forEach(line => {
            let trimmed = line.trim();
            if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
                if (listStack.length === 0) { 
                    listStack.push('ul'); 
                    processedLines.push('<ul class="list-disc pl-5 space-y-1 text-slate-700">'); 
                }
                processedLines.push(`<li>${trimmed.substring(2)}</li>`);
            } else {
                if (listStack.length > 0) { 
                    processedLines.push(`</${listStack.pop()}>`); 
                }
                if (trimmed) {
                    processedLines.push(`<p class="text-slate-700">${trimmed}</p>`);
                }
            }
        });
        if (listStack.length > 0) {
            processedLines.push(`</${listStack.pop()}>`);
        }
        return processedLines.join('');
    }

    // --- FILE & IMAGE UTILITIES ---
    const fileToBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
    });

    const resizeImage = (file, maxWidth = 1536) => new Promise((resolve, reject) => {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let { width, height } = img;
            if (width > height) {
                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
            } else {
                if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; }
            }
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            canvas.toBlob(blob => resolve(new File([blob], file.name, { type: 'image/jpeg' })), 'image/jpeg', 0.85);
        };
        img.onerror = reject;
    });
    
    function handleAnswerImageUpload(event) {
        answerTextarea.value = '';
        state.answerText = '';
        
        const files = Array.from(event.target.files).map(file => ({ id: crypto.randomUUID(), file }));
        state.answerFiles.push(...files);
        state.answerFiles.sort((a, b) => a.file.name.localeCompare(b.file.name, undefined, { numeric: true }));
        
        updateUI();
    }
    
    function removeAnswerFile(id) {
        state.answerFiles = state.answerFiles.filter(f => f.id !== id);
        updateUI();
    }

    // --- CORE API LOGIC ---
    async function evaluateAnswer() {
        setLoading('evaluate', true);
        state.evaluationResult = null;
        state.generatedModelAnswer = null;
        outputSection.scrollIntoView({ behavior: 'smooth' });

        try {
            updateMessage('Preparing your answer...');
            const payloadParts = [];
            
            const prompt = `You are an expert UPSC Mains evaluator. Evaluate the answer based on the question. Your response MUST be in the specified JSON format only. Do not include any other text or markdown formatting around the JSON object.

**QUESTION:** ${state.questionText}

**JSON_FORMAT:**
{"score": int, "maxMarks": int, "detailed_feedback": {"introduction": {"strengths": "...", "weaknesses": "...", "suggestions_for_improvement": ["..."]}, "body_evaluation": [{"section_title": "...", "evaluation": {"strengths": "...", "weaknesses": "..."}}], "conclusion": {"strengths": "...", "weaknesses": "...", "suggestions_for_improvement": ["..."]}}, "overall_assessment": {"presentation_and_style": "...", "holistic_strengths": ["..."], "priority_areas_for_improvement": ["..."]}}`;
            
            payloadParts.push({ text: prompt });

            if (state.answerText.trim()) {
                payloadParts.push({ text: `\n\n**CANDIDATE'S ANSWER (TEXT):**\n${state.answerText}` });
            }

            if (state.answerFiles.length > 0) {
                for (const [i, item] of state.answerFiles.entries()) {
                    updateMessage(`Processing image ${i + 1}/${state.answerFiles.length}...`);
                    const resized = await resizeImage(item.file);
                    const base64 = await fileToBase64(resized);
                    payloadParts.push({ inlineData: { mimeType: resized.type, data: base64 } });
                }
            }
            
            const payload = { contents: [{ role: "user", parts: payloadParts }] };
            updateMessage('AI is analyzing... This may take a moment.');

            const response = await fetch('/api/proxy', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ mode: 'evaluate', payload }) 
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'The API request failed.');
            }
            
            const result = await response.json();
            
            const jsonText = result.candidates[0].content.parts[0].text;
            state.evaluationResult = JSON.parse(jsonText.match(/\{[\s\S]*\}/)[0]);
            updateMessage('Evaluation complete!', false);

        } catch (error) {
            console.error(error);
            updateMessage(`Error: ${error.message}`, true);
        } finally {
            setLoading('evaluate', false);
        }
    }
    
    async function generateFullModelAnswer() {
        setLoading('generate', true);
        state.evaluationResult = null;
        state.generatedModelAnswer = null;
        outputSection.scrollIntoView({ behavior: 'smooth' });

        try {
            updateMessage('Generating model answer...');
            const prompt = `You are a UPSC subject matter expert. Write a comprehensive, well-structured model answer for the question: "${state.questionText}". Use Markdown for formatting. Adhere to a 150/250 word limit as appropriate for the question's marks (assume 10 marks for ~150 words, 15 for ~250).`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            const response = await fetch('/api/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: 'generate', payload })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'The API request failed.');
            }

            const result = await response.json();
            state.generatedModelAnswer = result.candidates[0].content.parts[0].text;
            updateMessage('Model answer generated!', false);
        } catch (error) {
             console.error(error);
            updateMessage(`Error: ${error.message}`, true);
        } finally {
             setLoading('generate', false);
        }
    }

    function clearAll() {
        state.questionText = '';
        state.answerText = '';
        state.answerFiles = [];
        state.evaluationResult = null;
        state.generatedModelAnswer = null;
        
        questionTextarea.value = '';
        answerTextarea.value = '';
        answerFileInput.value = '';
        
        updateUI();
    }
</script>
</body>
</html>
