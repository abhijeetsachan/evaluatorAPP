<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mAIntor | UPSC Answer Evaluator</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='15' fill='%233b82f6'/%3E%3Ctext x='50' y='75' font-size='90' font-family='Poppins, sans-serif' font-weight='bold' text-anchor='middle' fill='white'%3EA%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; /* A lighter, more modern slate */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE 10+ and Edge */
            user-select: none; /* Standard syntax */
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* --- Toast Animations --- */
        @keyframes toast-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes toast-out {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }
        .toast-in {
            animation: toast-in 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards;
        }
        .toast-out {
            animation: toast-out 0.5s ease-in forwards;
        }

        /* --- Custom Radio Toggle --- */
        .radio-toggle-label {
            cursor: pointer;
            position: relative;
            padding: 0.5rem 1rem;
            transition: color 0.3s ease-in-out;
            color: #475569; /* slate-600 */
            z-index: 1; /* Keep label above background */
        }
        .radio-toggle input[type="radio"] {
            display: none;
        }
        .radio-toggle-bg {
            position: absolute;
            top: 4px; /* Corresponds to p-1 */
            left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background-color: #3b82f6; /* blue-600 */
            border-radius: 9999px;
            box-shadow: 0 4px 10px -2px rgb(59 130 246 / 0.4);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }
        .radio-toggle input[id="model-eval"]:checked ~ .radio-toggle-bg {
            transform: translateX(calc(100% + 4px));
        }
        .radio-toggle input[type="radio"]:checked + label {
            color: white;
        }
        
        /* --- ContentEditable Placeholder --- */
        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8; /* slate-400 */
            pointer-events: none;
            display: block;
        }

        /* --- Modern Card Style --- */
        .modern-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease-in-out;
        }
        
        /* --- Drag and Drop State --- */
        .drag-over {
            border-style: dashed !important;
            border-color: #3b82f6 !important; /* A nice blue to match the theme */
            background-color: rgba(59, 130, 246, 0.05) !important;
        }

        /* --- Preloader Styles --- */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #ffffff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.75s ease-out, visibility 0.75s ease-out;
            visibility: visible;
            opacity: 1;
        }
        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* --- Logo Styles --- */
        .logo-container {
            display: flex;
            align-items: center; /* Vertically align items */
            font-family: 'Poppins', sans-serif;
        }

        /* Styling for each letter span */
        .logo-container span {
            font-size: 6rem; /* Responsive font size */
            font-weight: 700;
            cursor: default;
            user-select: none;
            color: #333333; /* Dark grey for visibility on white */
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.1); /* Adjusted shadow for light background */
            opacity: 0;
            /* Use the new smooth slide-up animation */
            animation: slideUp 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        /* Staggered animation delay for each letter to appear sequentially */
        .logo-container > span:nth-of-type(1) { animation-delay: 0.2s; } /* m */
        .logo-container > span:nth-of-type(4) { animation-delay: 0.8s; } /* n */
        .logo-container > span:nth-of-type(5) { animation-delay: 1.0s; } /* t */
        .logo-container > span:nth-of-type(6) { animation-delay: 1.2s; } /* o */
        .logo-container > span:nth-of-type(7) { animation-delay: 1.4s; } /* r */

        /* Special styling for the 'A' and 'I' to highlight the AI component */
        .logo-container .ai {
            /* A vibrant gradient to make the AI stand out */
            background: linear-gradient(45deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            
            /* Replace with a new chained animation: first reveal, then a continuous pulse */
            animation: aiReveal 1.2s cubic-bezier(0.23, 1, 0.32, 1) forwards, pulseGlow 2s ease-in-out infinite alternate;

            /* Properties for the fill animation */
            background-size: 0% 100%;
            background-repeat: no-repeat;
        }

        /* Delays for A and I spans. The second delay value targets the second animation (pulseGlow) */
        .logo-container > span.ai:nth-of-type(2) {
            animation-delay: 0.4s, 1.6s; /* aiReveal starts at 0.4s, pulseGlow starts at 1.6s */
        }
        .logo-container > span.ai:nth-of-type(3) {
            animation-delay: 0.6s, 1.8s; /* aiReveal starts at 0.6s, pulseGlow starts at 1.8s */
        }

        /* --- Logo Size Overrides --- */
        .header-logo span {
            font-size: 1.75rem; /* Smaller for header */
        }
        .inline-loader span {
            font-size: 3rem; /* Mid-size for inline loader. */
        }
        
        /* --- Specific looping animation for the evaluation panel loader --- */
        .inline-loader span:not(.ai) {
             animation: slideUp 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards, pulseGlow 2.2s ease-in-out infinite alternate;
        }

        /* --- Logo Animation Keyframes --- */
        /* Smooth slide-up animation for standard letters */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Keyframe for the AI letters to slide up and then fill with color */
        @keyframes aiReveal {
            0% {
                opacity: 0;
                transform: translateY(30px);
                background-size: 0% 100%;
            }
            50% {
                opacity: 1;
                transform: translateY(0);
                background-size: 0% 100%;
            }
            100% {
                opacity: 1;
                transform: translateY(0);
                background-size: 100% 100%;
            }
        }

        /* New keyframe for the continuous pulsing glow effect */
        @keyframes pulseGlow {
            from {
                text-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
            }
            to {
                text-shadow: 0 0 25px rgba(59, 130, 246, 1);
            }
        }

        @media (max-width: 768px) {
            .logo-container span { font-size: 4rem; }
            .header-logo span { font-size: 1.5rem; }
            .inline-loader span { font-size: 2.5rem; }
        }
        @media (max-width: 480px) {
            .logo-container span { font-size: 3rem; }
            .header-logo span { font-size: 1.25rem; }
            .inline-loader span { font-size: 2rem; }
        }
    </style>
</head>

<body class=" text-slate-800">

    <div id="preloader">
        <div class="logo-container">
            <span>m</span>
            <span class="ai">A</span>
            <span class="ai">I</span>
            <span>n</span>
            <span>t</span>
            <span>o</span>
            <span>r</span>
        </div>
    </div>

    <div id="app" class="flex flex-col min-h-screen">
        <header class="bg-white/80 shadow-sm sticky top-0 z-10 backdrop-blur-md border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                 <h1 class="text-2xl font-bold text-slate-800 flex items-center">
                    <div class="logo-container header-logo">
                        <span>m</span>
                        <span class="ai">A</span>
                        <span class="ai">I</span>
                        <span>n</span>
                        <span>t</span>
                        <span>o</span>
                        <span>r</span>
                    </div>
                </h1>
                <button onclick="clearAll()" class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-blue-600 transition-all duration-300 transform hover:scale-105">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    Clear All
                </button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-grow w-full">
            <div class="grid grid-cols-1 gap-8">
                
                <div class="space-y-6">
                    <div class="modern-card p-6 rounded-xl shadow-lg fade-in" style="animation-delay: 0.1s;">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3 text-slate-700">
                            <svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                            UPSC Question
                        </h2>
                        <div class="relative">
                            <textarea id="question-textarea" class="w-full p-3 pr-12 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-200 min-h-[150px] text-base bg-slate-50/50" placeholder="Paste question text here, or drag & drop a file..."></textarea>
                            <label class="absolute top-2 right-2 p-2 rounded-full hover:bg-slate-200 cursor-pointer transition-all duration-200 transform hover:scale-110">
                                <svg class="w-5 h-5 text-slate-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                                <input id="question-file-input" type="file" accept="image/*,application/pdf" class="hidden" />
                            </label>
                        </div>
                    </div>
                    
                    <div class="modern-card p-6 rounded-xl shadow-lg fade-in" style="animation-delay: 0.2s;">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3 text-slate-700">Preferred Evaluation Method</h2>
                        <div class="relative flex items-center bg-slate-200/70 p-1 rounded-full radio-toggle">
                            <input type="radio" name="evaluationType" id="ai-eval" value="ai" checked>
                            <label for="ai-eval" class="radio-toggle-label w-1/2 text-center">AI Evaluation</label>
                            
                            <input type="radio" name="evaluationType" id="model-eval" value="model">
                            <label for="model-eval" class="radio-toggle-label w-1/2 text-center">Model Answer</label>
                            
                            <div class="radio-toggle-bg"></div>
                        </div>
                    </div>

                    <div id="model-answer-card" class="modern-card p-6 rounded-xl shadow-lg hidden">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3 text-slate-700">
                            <svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                            Model Answer
                        </h2>
                        <div class="relative">
                             <div id="model-answer-editor" contenteditable="true" 
                                  class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-200 min-h-[150px] text-base bg-slate-50/50 overflow-y-auto" 
                                  data-placeholder="Paste formatted model answer here, or drag & drop a file..."></div>
                            <label class="absolute top-2 right-2 p-2 rounded-full hover:bg-slate-200 cursor-pointer transition-all duration-200 transform hover:scale-110">
                                <svg class="w-5 h-5 text-slate-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                                <input id="model-answer-file-input" type="file" accept="image/*,application/pdf" class="hidden" />
                            </label>
                        </div>
                         <p class="text-xs text-slate-500 mt-2">For text-based PDFs, paste content directly for best results. For image-based PDFs, upload will only OCR the first page.</p>
                    </div>

                    <div class="modern-card p-6 rounded-xl shadow-lg fade-in" style="animation-delay: 0.3s;">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3 text-slate-700">
                            <svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                            Your Answer
                        </h2>
                        <div class="relative">
                            <textarea id="answer-textarea" class="w-full p-3 pr-12 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-200 min-h-[120px] text-base bg-slate-50/50" placeholder="Paste answer text here, or drag & drop images..."></textarea>
                            <label class="absolute top-2 right-2 p-2 rounded-full hover:bg-slate-200 cursor-pointer transition-all duration-200 transform hover:scale-110">
                                <svg class="w-5 h-5 text-slate-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                                <input id="answer-file-input" type="file" accept="image/*" multiple class="hidden" />
                            </label>
                        </div>
                        <div id="answer-files-container" class="mt-4 space-y-2"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 fade-in" style="animation-delay: 0.4s;">
                        <button id="evaluate-btn" onclick="evaluateAnswer()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>
                            Evaluate Answer
                        </button>
                        <button id="generate-btn" onclick="generateFullModelAnswer()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-700 text-white font-semibold rounded-lg shadow-lg hover:bg-slate-800 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                             <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9L12 18l1.9-5.8 5.8-1.9-5.8-1.9L12 3z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                             Generate Model Answer
                        </button>
                    </div>
                </div>

                <div>
                    <div class="modern-card p-6 rounded-xl shadow-lg min-h-[600px] fade-in" style="animation-delay: 0.5s;">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-xl font-semibold flex items-center gap-3 text-slate-700">
                                 <svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                                 Evaluation/Model Answer Panel
                            </h2>
                             <button id="copy-output-btn" onclick="copyOutputToClipboard()" class="hidden flex-shrink-0 items-center gap-2 text-sm font-medium text-slate-600 hover:text-blue-600 transition-all duration-300 transform hover:scale-105 p-2 rounded-lg hover:bg-slate-100">
                                 <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>
                                 Copy
                             </button>
                        </div>
                        <div id="output-container">
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center py-6 text-sm text-slate-500 border-t border-slate-200 bg-white/50">
            <p>Created with ❤️ by Poindexter</p>
        </footer>
    </div>
    
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 w-full max-w-xs space-y-3"></div>

<script>
    // --- IMPORTANT: The API key is now removed from here for security. ---
    
    // --- GLOBAL STATE & DOM REFERENCES ---
    let state = {
        questionText: '',
        answerText: '',
        modelAnswerText: '',
        answerFiles: [], // will be an array of { id, file }
        loadingState: { ocrQuestion: false, ocrModelAnswer: false, evaluate: false, fullAnswer: false },
        generatedModelAnswer: '',
        evaluationResult: null,
        message: '',
        evaluationType: 'ai', // 'ai' or 'model'
    };
    
    const PROXY_API_URL = '/api/proxy'; // All requests will go through our own secure backend

    // DOM Elements
    let questionTextarea, questionFileInput, answerTextarea, answerFileInput, answerFilesContainer, evaluateBtn, generateBtn, outputContainer, modelAnswerCard, modelAnswerEditor, modelAnswerFileInput, evaluationTypeRadios;

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize DOM elements after the DOM is fully loaded
        questionTextarea = document.getElementById('question-textarea');
        questionFileInput = document.getElementById('question-file-input');
        answerTextarea = document.getElementById('answer-textarea');
        answerFileInput = document.getElementById('answer-file-input');
        answerFilesContainer = document.getElementById('answer-files-container');
        evaluateBtn = document.getElementById('evaluate-btn');
        generateBtn = document.getElementById('generate-btn');
        outputContainer = document.getElementById('output-container');
        modelAnswerCard = document.getElementById('model-answer-card');
        modelAnswerEditor = document.getElementById('model-answer-editor');
        modelAnswerFileInput = document.getElementById('model-answer-file-input');
        evaluationTypeRadios = document.querySelectorAll('input[name="evaluationType"]');

        // Add event listeners
        questionTextarea.addEventListener('input', (e) => {
            state.questionText = e.target.value;
            updateButtons();
        });
        answerTextarea.addEventListener('input', (e) => {
            state.answerText = e.target.value;
            updateButtons();
        });
        modelAnswerEditor.addEventListener('input', (e) => {
            state.modelAnswerText = e.target.innerHTML; // Store full HTML to preserve formatting
            updateButtons();
        });

        questionFileInput.addEventListener('change', (e) => handleFileUpload(e, 'question'));
        answerFileInput.addEventListener('change', handleAnswerImageUpload);
        modelAnswerFileInput.addEventListener('change', (e) => handleFileUpload(e, 'modelAnswer'));
        
        evaluationTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.evaluationType = e.target.value;
                updateUI();
            });
        });

        // --- SETUP DRAG & DROP AND PASTE ---
        function setupInputArea(containerElem, inputElem, fileHandler) {
            if (!containerElem || !inputElem) return;
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                containerElem.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                containerElem.addEventListener(eventName, () => containerElem.classList.add('drag-over'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                containerElem.addEventListener(eventName, () => containerElem.classList.remove('drag-over'), false);
            });
            containerElem.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                if (files && files.length) fileHandler({ target: { files: files } });
            }, false);
            inputElem.addEventListener('paste', e => {
                const files = e.clipboardData.files;
                if (files && files.length > 0) {
                     e.preventDefault();
                     fileHandler({ target: { files: files } });
                }
            });
        }
        const questionCard = questionTextarea.closest('.modern-card');
        const answerCard = answerTextarea.closest('.modern-card');
        const modelAnswerDropCard = modelAnswerEditor.closest('.modern-card');
        setupInputArea(questionCard, questionTextarea, (e) => handleFileUpload(e, 'question'));
        setupInputArea(answerCard, answerTextarea, handleAnswerImageUpload);
        setupInputArea(modelAnswerDropCard, modelAnswerEditor, (e) => handleFileUpload(e, 'modelAnswer'));

        updateUI(); // Initial render
    });

    // --- PRELOADER LOGIC ---
    window.onload = function() {
        const preloader = document.getElementById('preloader');
        if (preloader) {
            setTimeout(() => {
                preloader.classList.add('hidden');
            }, 2000); // Let animation play out
        }
    };

    // --- STATE MANAGEMENT & UI UPDATE ---
    function updateMessage(message, isError = false, duration = 4000) {
        state.message = message;
        if (!message) return;
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        const toast = document.createElement('div');
        const baseClasses = 'p-4 rounded-xl shadow-lg flex items-center gap-3 text-sm font-medium w-full';
        const typeClasses = isError ? 'bg-red-500 text-white' : 'bg-white text-slate-800 border border-slate-200';
        toast.className = `${baseClasses} ${typeClasses} toast-in`;
        const icon = isError 
            ? `<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            : `<svg class="w-6 h-6 flex-shrink-0 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        toast.innerHTML = `${icon}<span>${message}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.classList.remove('toast-in');
            toast.classList.add('toast-out');
            toast.addEventListener('animationend', () => toast.remove());
        }, duration);
    }
    
    function setLoading(key, value) {
        state.loadingState[key] = value;
        updateUI();
    }

    function updateUI() {
        if (!questionTextarea) return;
        questionTextarea.value = state.questionText;
        answerTextarea.value = state.answerText;
        if (modelAnswerEditor && document.activeElement !== modelAnswerEditor) {
            modelAnswerEditor.innerHTML = state.modelAnswerText;
        }
        answerTextarea.readOnly = state.answerFiles.length > 0;
        if (modelAnswerCard) {
            if (state.evaluationType === 'model') {
                modelAnswerCard.classList.remove('hidden');
                modelAnswerCard.classList.add('fade-in');
            } else {
                modelAnswerCard.classList.add('hidden');
            }
        }
        renderAnswerFiles();
        renderOutput();
        updateButtons();
    }

    function updateButtons() {
        if (!evaluateBtn) return;
        const isAnyLoading = Object.values(state.loadingState).some(Boolean);
        let isEvaluateDisabled = isAnyLoading || !state.questionText.trim() || (!state.answerText.trim() && state.answerFiles.length === 0);
        if (state.evaluationType === 'model' && !state.modelAnswerText.trim()) {
            isEvaluateDisabled = true;
        }
        evaluateBtn.disabled = isEvaluateDisabled;
        generateBtn.disabled = isAnyLoading || !state.questionText.trim();
    }

    function renderAnswerFiles() {
        if (!answerFilesContainer) return;
        answerFilesContainer.innerHTML = '';
        state.answerFiles.forEach(item => {
            const fileDiv = document.createElement('div');
            fileDiv.className = "flex items-center justify-between bg-slate-100 p-2 rounded-md text-sm";
            fileDiv.innerHTML = `
                <span class="truncate">${item.file.name}</span>
                <button onclick="removeAnswerFile('${item.id}')" class="text-slate-500 hover:text-red-600 p-1 transition-colors">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                </button>
            `;
            answerFilesContainer.appendChild(fileDiv);
        });
    }

    function removeAnswerFile(id) {
        state.answerFiles = state.answerFiles.filter(f => f.id !== id);
        updateUI();
    }

    function renderOutput() {
        if (!outputContainer) return;
        const copyBtn = document.getElementById('copy-output-btn');
        const isAnyLoading = Object.values(state.loadingState).some(Boolean);

        if (isAnyLoading) {
            if (copyBtn) copyBtn.classList.add('hidden');
            outputContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-96">
                    <div class="logo-container inline-loader">
                        <span>m</span><span class="ai">A</span><span class="ai">I</span><span>n</span><span>t</span><span>o</span><span>r</span>
                    </div>
                    <p class="mt-4 text-slate-600 font-medium">${state.message || 'Processing...'}</p>
                </div>`;
        } else if (state.evaluationResult) {
            if (copyBtn) copyBtn.classList.remove('hidden');
            const result = state.evaluationResult;
            let bodyHtml = (result.body_paragraphs_evaluation || []).map((para, index) => `
                <div class="pt-4">
                    <h5 class="font-semibold text-slate-700">Paragraph ${index + 1}: <span class="text-slate-500 font-normal italic">"${para.paragraph_start || ''}..."</span></h5>
                    <div class="prose prose-sm max-w-none text-slate-600 mt-2 space-y-3">
                        <div><p class="font-semibold text-slate-600">Strengths:</p>${renderMarkdown(para.strengths)}</div>
                        <div><p class="font-semibold text-slate-600">Weaknesses:</p>${renderMarkdown(para.weaknesses)}</div>
                        <div><p class="font-semibold text-slate-600">Suggestions for Improvement:</p>${renderMarkdown(para.suggestions_for_improvement)}</div>
                    </div>
                </div>`).join('<hr class="my-4 border-slate-200">');

            outputContainer.innerHTML = `
                <div class="space-y-6">
                    <div class="text-center bg-slate-100 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-slate-600">Score</h3>
                        <p class="text-4xl font-bold text-blue-600 mt-1 tracking-tight">${result.score} / ${result.maxMarks}</p>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-slate-800 border-b pb-2">Detailed Evaluation</h3>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-slate-700 mb-2">A. Introduction Evaluation</h4>
                            <div class="prose prose-sm max-w-none text-slate-600 space-y-3">
                                <div><p class="font-semibold text-slate-600">Strengths:</p>${renderMarkdown(result.introduction_evaluation?.strengths)}</div>
                                <div><p class="font-semibold text-slate-600">Weaknesses & Counterpoints:</p>${renderMarkdown(result.introduction_evaluation?.weaknesses)}</div>
                                <div><p class="font-semibold text-slate-600">Suggestions for Improvement:</p>${renderMarkdown(result.introduction_evaluation?.suggestions)}</div>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-slate-700 mb-2">B. Body Paragraphs Evaluation</h4>
                            ${bodyHtml}
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-slate-700 mb-2">C. Conclusion Evaluation</h4>
                            <div class="prose prose-sm max-w-none text-slate-600 space-y-3">
                                <div><p class="font-semibold text-slate-600">Strengths:</p>${renderMarkdown(result.conclusion_evaluation?.strengths)}</div>
                                <div><p class="font-semibold text-slate-600">Weaknesses:</p>${renderMarkdown(result.conclusion_evaluation?.weaknesses)}</div>
                                <div><p class="font-semibold text-slate-600">Suggestions for Improvement:</p>${renderMarkdown(result.conclusion_evaluation?.suggestions)}</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-2">Overall Feedback:</h3>
                        <div class="prose prose-sm max-w-none">${renderMarkdown(result.overall_feedback)}</div>
                    </div>
                </div>`;
        } else if (state.generatedModelAnswer) {
             if (copyBtn) copyBtn.classList.remove('hidden');
             outputContainer.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-2">Model Answer:</h3>
                        <div class="prose prose-sm max-w-none">${renderMarkdown(state.generatedModelAnswer)}</div>
                    </div>
                </div>`;
        } else {
             if (copyBtn) copyBtn.classList.add('hidden');
             outputContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-96 text-center">
                    <svg class="w-16 h-16 text-slate-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                    <p class="mt-4 text-slate-600">Your evaluation report will appear here.</p>
                    <p class="text-sm text-slate-500">Enter a question and answer, then click "Evaluate".</p>
                </div>`;
        }
    }

    // --- Custom Markdown rendering function ---
    function renderMarkdown(markdownText) {
        if (!markdownText) return '';
        let html = markdownText.replace(/```([\s\S]*?)```/g, (match, code) => {
            const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `<pre class="bg-slate-100 p-3 rounded-md overflow-x-auto"><code class="text-sm font-mono">${escapedCode.trim()}</code></pre>`;
        });
        let lines = html.split('\n');
        let processedLines = [];
        let listStack = [];
        let inCodeBlock = false;
        lines.forEach(line => {
            if (line.includes('<pre')) { inCodeBlock = true; processedLines.push(line); return; }
            if (line.includes('</pre>')) { inCodeBlock = false; processedLines.push(line); return; }
            if (inCodeBlock) { processedLines.push(line); return; }
            const trimmedLine = line.trim();
            const leadingSpaces = line.length - line.trimStart().length;
            if (trimmedLine.startsWith('### ')) {
                while (listStack.length > 0) { processedLines.push(`</${listStack.pop().type}>`); }
                processedLines.push(`<h3 class="text-lg font-semibold mt-4 mb-2 text-slate-700">${trimmedLine.substring(4)}</h3>`);
                return;
            }
            if (trimmedLine.startsWith('## ')) {
                while (listStack.length > 0) { processedLines.push(`</${listStack.pop().type}>`); }
                processedLines.push(`<h2 class="text-xl font-bold mt-6 mb-3 text-slate-800">${trimmedLine.substring(3)}</h2>`);
                return;
            }
            const isBullet = trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ');
            const isNumbered = trimmedLine.match(/^\d+\.\s/);
            if (isBullet || isNumbered) {
                const currentType = isBullet ? 'ul' : 'ol';
                const currentIndent = leadingSpaces;
                while (listStack.length > 0 && listStack[listStack.length - 1].indent >= currentIndent) {
                    processedLines.push(`</${listStack.pop().type}>`);
                }
                if (listStack.length === 0 || listStack[listStack.length - 1].type !== currentType || listStack[listStack.length - 1].indent < currentIndent) {
                    processedLines.push(`<${currentType} class="list-${currentType === 'ul' ? 'disc' : 'decimal'} pl-5 space-y-2">`);
                    listStack.push({ type: currentType, indent: currentIndent });
                }
                let listItemContent = isBullet ? trimmedLine.substring(trimmedLine.indexOf(' ') + 1) : trimmedLine.substring(trimmedLine.indexOf('.') + 2);
                let formattedListItemContent = listItemContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                processedLines.push(`<li class="text-slate-600 leading-relaxed">${formattedListItemContent.trim()}</li>`);
            } else {
                while (listStack.length > 0) { processedLines.push(`</${listStack.pop().type}>`); }
                if (trimmedLine.length > 0) {
                    let formattedParagraphContent = trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                    processedLines.push(`<p class="text-slate-600 leading-relaxed">${formattedParagraphContent}</p>`);
                }
            }
        });
        while (listStack.length > 0) { processedLines.push(`</${listStack.pop().type}>`); }
        return processedLines.join('\n');
    };
    

    // --- Helper for exponential backoff ---
    const fetchWithRetry = async (url, options, retries = 3) => {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429) {
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(res => setTimeout(res, delay));
                    continue;
                }
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    let errorData;
                    if (contentType && contentType.includes('application/json')) {
                        errorData = await response.json();
                        throw new Error(`API error: ${response.status} - ${errorData.error?.message || JSON.stringify(errorData)}`);
                    } else {
                        errorData = await response.text();
                        throw new Error(`API error: ${response.status} - ${errorData}`);
                    }
                }
                return response;
            } catch (error) {
                if (i === retries - 1) throw error;
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await new Promise(res => setTimeout(res, delay));
            }
        }
    };


    // --- Helper to infer word limit and max marks ---
    const getInferredLimits = (questionText) => {
        let inferredMaxMarks = 10;
        let inferredWordLimit = '150 words';
        const lowerCaseText = questionText.toLowerCase();
        const hindiText = questionText;
        if (lowerCaseText.includes('250 words') || hindiText.includes('२५० शब्दों')) {
            inferredMaxMarks = 15;
            inferredWordLimit = '250 words';
        } else if (lowerCaseText.includes('150 words') || hindiText.includes('१५० शब्दों')) {
            inferredMaxMarks = 10;
            inferredWordLimit = '150 words';
        }
        return { inferredMaxMarks, inferredWordLimit };
    };


    // --- Helper to detect language ---
    const detectLanguage = (text) => {
        const hindiRegex = /[\u0900-\u097F]/;
        return hindiRegex.test(text) ? 'hi' : 'en';
    };


    // --- FILE & OCR HANDLING ---
    const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = (error) => reject(error);
    });

    const performOcr = async (file, ocrType) => {
        if (!file) return '';
        setLoading(ocrType, true);
        updateMessage(`Performing OCR on ${ocrType.replace('ocr', '')} file...`);
        try {
            const base64Image = await fileToBase64(file);
            const prompt = "Extract all text from this image or PDF page, including handwritten text, in its original language (English or Hindi). Provide the extracted text as plain text.";
            const payload = { 
                mode: 'ocr',
                prompt: prompt,
                file: { mimeType: file.type, data: base64Image }
            };
            const response = await fetchWithRetry(PROXY_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                updateMessage(`OCR for ${ocrType.replace('ocr', '')} successful.`);
                return result.candidates[0].content.parts[0].text;
            } else if (result.error) {
                 updateMessage(`Error during OCR: ${result.error}`, true);
                 return '';
            }
            updateMessage(`Could not extract text from ${ocrType.replace('ocr', '')} file.`, true);
            return '';
        } catch (error) {
            console.error('OCR Error:', error);
            updateMessage(`Error during OCR for ${ocrType.replace('ocr', '')}: ${error.message}`, true);
            return '';
        } finally {
            setLoading(ocrType, false);
        }
    };
    
    async function handleFileUpload(event, type) {
        const file = event.target.files[0];
        if (file) {
            const ocrText = await performOcr(file, `ocr${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (type === 'question') {
                 state.questionText = ocrText;
            } else if (type === 'modelAnswer') {
                state.modelAnswerText = ocrText;
            }
            updateUI();
        }
    }

    function handleAnswerImageUpload(event) {
        let selectedFiles = Array.from(event.target.files);
        if (state.answerFiles.length + selectedFiles.length > 10) {
            updateMessage('Maximum of 10 images allowed.', true);
            return;
        }
        selectedFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
        const newFilesWithIds = selectedFiles.map(file => ({ id: crypto.randomUUID(), file }));
        state.answerFiles = [...state.answerFiles, ...newFilesWithIds];
        updateMessage(`Added ${selectedFiles.length} image(s).`);
        state.answerText = '';
        state.evaluationResult = null;
        updateUI();
    };

    // --- CORE AI FUNCTIONS ---
    async function evaluateAnswer() {
        if (state.evaluationType === 'ai') {
            evaluateWithAI();
        } else {
            evaluateWithModelAnswer();
        }
    }
    
    // REFACTORED HELPER for API calls
    async function _callEvaluationApi(prompt) {
        const payloadParts = [{ text: prompt }];
        if (state.answerFiles.length > 0) {
            try {
                for (const item of state.answerFiles) {
                    const base64Image = await fileToBase64(item.file);
                    payloadParts.push({ inlineData: { mimeType: item.file.type, data: base64Image } });
                }
            } catch (error) {
                updateMessage(`Error processing images for evaluation: ${error.message}`, true);
                return null;
            }
        }

        const payload = {
            contents: [{ role: "user", parts: payloadParts }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: { type: "OBJECT", properties: { "score": { "type": "NUMBER" }, "maxMarks": { "type": "NUMBER" }, "introduction_evaluation": { type: "OBJECT", properties: { "strengths": { "type": "STRING" }, "weaknesses": { "type": "STRING" }, "suggestions": { "type": "STRING" } } }, "body_paragraphs_evaluation": { type: "ARRAY", items: { type: "OBJECT", properties: { "paragraph_start": { "type": "STRING" }, "strengths": { "type": "STRING" }, "weaknesses": { "type": "STRING" }, "suggestions_for_improvement": { "type": "STRING" } } } }, "conclusion_evaluation": { type: "OBJECT", properties: { "strengths": { "type": "STRING" }, "weaknesses": { "type": "STRING" }, "suggestions": { "type": "STRING" } } }, "overall_feedback": { "type": "STRING" } } }
            },
        };

        try {
            const backendPayload = { mode: 'evaluate', payload: payload };
            const response = await fetchWithRetry(PROXY_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(backendPayload) });
            const result = await response.json();
            if (result.error) throw new Error(result.error);
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                return JSON.parse(result.candidates[0].content.parts[0].text);
            }
            return null;
        } catch (error) {
            console.error('API Evaluation Error:', error);
            updateMessage(`Error during evaluation: ${error.message}`, true);
            return null;
        }
    }


    async function evaluateWithAI() {
        if (!state.questionText.trim() || (!state.answerText.trim() && state.answerFiles.length === 0)) {
            updateMessage('Please provide a question and an answer.', true);
            return;
        }
        setLoading('evaluate', true);
        state.evaluationResult = null;
        state.generatedModelAnswer = '';
        updateMessage('Performing comprehensive AI evaluation...');
        
        const { inferredMaxMarks } = getInferredLimits(state.questionText);
        const language = detectLanguage(state.questionText);
        
        let answerContentPrompt = state.answerFiles.length > 0
            ? "The candidate's answer is in the following images. Please analyze the handwritten text and any diagrams directly from these images."
            : `The candidate's answer is: "${state.answerText}"`;

        const englishPrompt = `
            You are my personal UPSC mentor... [Your detailed prompt remains the same]
            **Question:** "${state.questionText}"
            **Your Answer:** ${answerContentPrompt}
            **Maximum Marks:** ${inferredMaxMarks}
            ...
        `;
        
        const hindiPrompt = `
            आप मेरे व्यक्तिगत यूपीएससी मेंटर हैं।... [Your detailed prompt remains the same]
            **प्रश्न:** "${state.questionText}"
            **आपका उत्तर:** ${answerContentPrompt}
            **अधिकतम अंक:** ${inferredMaxMarks}
            ...
        `;

        const prompt = language === 'hi' ? hindiPrompt : englishPrompt;
        
        const parsedResult = await _callEvaluationApi(prompt);

        if (parsedResult) {
            state.evaluationResult = parsedResult;
            updateMessage('Evaluation complete!');
        } else {
            updateMessage('Could not get a valid AI evaluation.', true);
        }
        setLoading('evaluate', false);
    }

    async function evaluateWithModelAnswer() {
        if (!state.modelAnswerText.trim()) {
            updateMessage('Please provide the model answer.', true);
            return;
        }
        setLoading('evaluate', true);
        state.evaluationResult = null;
        state.generatedModelAnswer = '';
        updateMessage('Evaluating based on model answer...');

        const { inferredMaxMarks } = getInferredLimits(state.questionText);
        const language = detectLanguage(state.questionText);
        
        let answerContentPrompt = state.answerFiles.length > 0
            ? "The candidate's answer is in the following images."
            : `The candidate's answer is: "${state.answerText}"`;
                
        const englishPrompt = `
            You are my personal UPSC mentor... [Your detailed prompt remains the same]
            **Question:** "${state.questionText}"
            **Model Answer:** "${state.modelAnswerText}"
            **My Answer:** ${answerContentPrompt}
            **Maximum Marks:** ${inferredMaxMarks}
            ...
        `;

        const hindiPrompt = `
             आप मेरे व्यक्तिगत यूपीएससी मेंटर हैं।... [Your detailed prompt remains the same]
            **प्रश्न:** "${state.questionText}"
            **मॉडल उत्तर:** "${state.modelAnswerText}"
            **मेरा उत्तर:** ${answerContentPrompt}
            **अधिकतम अंक:** ${inferredMaxMarks}
            ...
        `;

        const prompt = language === 'hi' ? hindiPrompt : englishPrompt;
        
        const parsedResult = await _callEvaluationApi(prompt);

        if (parsedResult) {
            state.evaluationResult = parsedResult;
            updateMessage('Model answer evaluation complete!');
        } else {
            updateMessage('Could not get a valid evaluation from the model answer.', true);
        }
        setLoading('evaluate', false);
    }
    
    async function generateFullModelAnswer() {
        if (!state.questionText.trim()) {
            updateMessage('Please provide a question to generate a model answer.', true);
            return;
        }
        setLoading('fullAnswer', true);
        state.generatedModelAnswer = '';
        state.evaluationResult = null;
        updateMessage('Generating a comprehensive model answer...');

        const { inferredWordLimit } = getInferredLimits(state.questionText);
        const language = detectLanguage(state.questionText);
        
        let targetWordCountText = (inferredWordLimit === '150 words') ? '450-500 words' : '650-700 words';
        let targetWordCountTextHindi = (inferredWordLimit === '150 words') ? '४५०-५०० शब्दों' : '६५०-७०० शब्दों';

        const englishPrompt = `
            You are a UPSC subject matter expert. For the purpose of creating a detailed study resource, write a comprehensive, well-structured model answer for the following question that is significantly more detailed than a standard exam answer.
            **Instructions:**
            - Your answer should be in the range of ${targetWordCountText}. This is intentionally longer than the typical exam limit to provide in-depth analysis.
            - Structure the answer with a clear Introduction, Body, and Conclusion.
            - Use Markdown for formatting: '##' for main headings and '###' for subheadings. Use bullet points ('* ') for lists.
            - Ensure the content is accurate, relevant, and covers all aspects of the question in detail, providing ample examples, data, and citations where appropriate.
            - The tone should be formal and academic.
            **Question:** "${state.questionText}"
        `;

        const hindiPrompt = `
            You are a UPSC subject matter expert... [Your detailed prompt remains the same]
            - Your answer should be in the range of ${targetWordCountTextHindi}.
            **Question:** "${state.questionText}"
        `;
        
        const prompt = language === 'hi' ? hindiPrompt : englishPrompt;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

        try {
            const backendPayload = { mode: 'generate', payload: payload };
            const response = await fetchWithRetry(PROXY_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(backendPayload) });
            const result = await response.json();
            if (result.error) throw new Error(result.error);
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                state.generatedModelAnswer = result.candidates[0].content.parts[0].text;
                updateMessage('');
            } else {
                updateMessage('Could not generate a model answer.', true);
            }
        } catch (error) {
            console.error('Model Answer Generation Error:', error);
            updateMessage(`Error generating model answer: ${error.message}`, true);
        } finally {
            setLoading('fullAnswer', false);
        }
    };

    // --- UTILITY FUNCTIONS ---
    function clearAll(resetFileInputs = true) {
        state.questionText = '';
        state.answerText = '';
        state.modelAnswerText = '';
        state.answerFiles = [];
        state.generatedModelAnswer = '';
        state.evaluationResult = null;
        state.evaluationType = 'ai';
        if(document.getElementById('ai-eval')) {
            document.getElementById('ai-eval').checked = true;
        }
        if(modelAnswerEditor) {
             modelAnswerEditor.innerHTML = '';
        }
        updateMessage('');
        if (resetFileInputs) {
            if(questionFileInput) questionFileInput.value = '';
            if(answerFileInput) answerFileInput.value = '';
            if(modelAnswerFileInput) modelAnswerFileInput.value = '';
        }
        updateUI();
    };

    function copyOutputToClipboard() {
        const outputContainer = document.getElementById('output-container');
        if (outputContainer && outputContainer.innerText.trim()) {
            // Using a temporary textarea to preserve formatting for clipboard copy
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = outputContainer.innerText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                updateMessage('Content copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy: ', err);
                updateMessage('Could not copy to clipboard.', true);
            }
            document.body.removeChild(tempTextArea);
        }
    }

</script>

</body>
</html>

